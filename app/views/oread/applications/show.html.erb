<% title @application.name, false %>

<% content_for :breadcrumbs do %>
  <%= content_tag :li, link_to('home', root_url) %>
  <%= content_tag :li, link_to('Explore', explore_url) %>
  <%= content_tag :li, @application.name, class: 'active' %>
<% end %>

<% content_for :sidebar do %>
  <%= content_tag :div, class: 'panel panel-warning' do %>
    <div class="panel-heading">
      <strong>You have admin priviledges on this application!</strong>
    </div>
    <div class="panel-body">
      <%= link_to fa_icon('edit', text: 'Administrate'), edit_settings_admin_oread_application_path(@application), class: 'btn btn-warning' if can? :update, @application %>
      <%= link_to fa_icon('remove', text: 'Delete'), [:settings, :admin, @application], method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger' if can? :destroy, @application %>
    </div>
  <% end if can?(:edit, @application) || can?(:destroy, @application) %>

  <% if current_user %>
    <div id="user-application-token" class="panel panel-default">
      <div class="panel-heading">
        <strong>Personal Access Token</strong>
        <%= link_to fa_icon('plus', text: 'personal token'), new_settings_admin_oread_application_token_path(@application), class: 'btn btn-default btn-xs pull-right', style: '' if can? :create, Oread::AccessToken %>
      </div>
      <div class="panel-body bg-danger">
        <% if @token %>
          <p><strong><%= @token.token %></strong></p>
          <td><%= @token.refresh_token %></td>
          <td><%= @token.expires_in %></td>
          <td><%= @token.token_type %></td>
          <td>
            <%= @token.created_at %>
            <%= link_to fa_icon('remove'), settings_admin_oread_application_token_path(@application, @token), method: :delete, class: 'pull-right' %>
          </td>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= content_tag :div, class: 'panel panel-info' do %>
    <div class="panel-heading">
      <strong>What is a search-/readable application?</strong>
    </div>
    <div class="panel-body">
      <p>
        Dies sind Applikationen die durchsuchbar sind. Insofern die Zugriffsrechte auf Daten dieser Applikationen begrenzt sind, 
        kann ein Zugriffstoken angegeben werden um Inhalte zusammen zu führen. Das Token ist personalisiert und wird über Schnittstellen 
        an über babylon-online.org authentifizierte Applikationen weiter gegeben.
      </p>
    </div>
  <% end %>

<% end %>

<div class="row">
  <div class="col-md-5">
    <div class='panel panel-default' id="application-<%= @application.id %>-description">
      <%= render_image_or_pattern(@application.image, @application.image_url(:small_banner), @application.name) %>
      <div class="panel-body text-center">
        <h4><%= @application.name %></h4>
        <p class="small text-muted">Created on <%= @application.created_at.to_date.to_formatted_s(:long_ordinal) %>. <%= pluralize( @application.users.uniq.count, 'user' ) %></p>
      </div>
    </div>
    <div class='panel panel-default'>
      <div class="panel-body">
        <p>
          API: <%= link_to @application.url, @application.url, target: '_blank' %><br>
          External link: <%= link_to @application.app_url, @application.app_url, target: '_blank' %>
        </p>
        <p>
          Administration/Owner: <%= @application.owner.try(:name) %>
        </p>
      </div>
    </div>

    <%= content_tag :div, class: 'list-group' do %>
    <h4>Users</h4>
      <% for user in @application.users.uniq do %>
        <%= render partial: "/#{user.to_partial_path}", object: user %>    
      <% end %>
    <% end if @application.users.any? %>

  </div>

  <div class="col-md-7">
    <%= form_tag oread_application_path(@application), :method => 'get', class: "" do %>
      <div class="input-group">
        <span class="input-group-addon">
          <%= link_to fa_icon('search'), help_path(anchor: 'searching') %>
        </span>
        <%= search_field_tag :q, params[:q], placeholder: "Search #{@application.name} by Keyword", class: "form-control" %>
      </div>
    <% end %>

    <% if @results.present? %>
      <table class="table table-bordered table-responsive" style="margin-top:20px;">
        <tbody>
          <% @results.each do |result| %>
            <tr>
              <td>
                <%= link_to result['full_entry'], result['links']['human'] %><br>
                <!-- <%= content_tag :span, "#{result['type']}<br>".html_safe if result['type'] %> -->
                <small><%= result['links']['human'] %></small>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <%= content_tag :p, "no results for <strong>#{params[:q]}</strong>".html_safe, class: 'bg-info', style: 'padding: 15px; margin-top: 20px;' if params[:q] && !params[:q].empty? %>
      <br>
      <h4>About</h4>
      <%= content_tag :div, markdown(@application.description), id: 'project-description' %>
    <% end %>
  </div>
</div>